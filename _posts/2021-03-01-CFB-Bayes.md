---
layout: post
title: Bayesian Updating of College Football Completion Percentage
excerpt: "Producing a Bayesian beta binomial model to analyze various CFB QB's completion percentage"
modified: 2/29/2016, 9:00:24
tags: [intro, beginner, jekyll, tutorial]
comments: true
category: blog
---

Recently I have been reading Statistical Rethinking along with Introduction to Empirical Bayes: Examples from Baseball Statistics. Both discuss Bayesian techniques in R, the latter discussing Bayes in the context of baseball and batting averages. This got me thinking of binary outcomes that I could measure in football and how to apply some of the techniques outlined by the author. One topic that quickly came to mind was completion percentage in college football (as CFB doesn't have CPOE data I figured this would be more applicable than NFL). In this post, I establish a framework for evaluating CFB QB completion percentage with bayes and informative priors that take advantage of recruit ranks.

## Data & Cleaning

I used the CFB Fast R API to obtain CFB QB data from 2014 to 2020. In addition, I loaded in CFB recruiting class data from the CFB Data API for the years 2000 to 2020. Not all of these years are needed but I wanted to ensure that any QB who played in our play by play dataset was captured by the recruiting data. I then filtered for dual threat and pro players (both QBs) and merged recruit info with pbp data. Below is a code snippet of the data call, full cleaning can be found in my GitHub but it primarily involves joining the data and making sure there are no issues.

```{r}
pbp <- data.frame() #blank frame
#Loop
for (x in 2014:2020) {
  progressr::with_progress({
  future::plan("multisession")
  qb_perf <- cfbfastR::load_cfb_pbp(x)
  qb_perf <- qb_perf %>%
  filter(pass == 1) %>%
  dplyr::select(passer_player_name,
         year,
         week,
         pos_team,
         def_pos_team,
         EPA, 
         pass,
         game_id,
         id_play,
         game_play_number, 
         completion,
         pass_attempt)
  pbp <- rbind(pbp, qb_perf)
  
  })
}
qb_ratings <- data.frame() #blank data frame for merging
for (x in 2000:2020) {
  PRO  <- cfbd_recruiting_player(x, position = "PRO")
  DUAL <- cfbd_recruiting_player(x, position = "DUAL")
  qb_ratings <- rbind(qb_ratings, PRO, DUAL)
}
```
## Exploring Predictors of QB Completion Percentage

### Recruiting Rankings

When evaluating CFB QB's, we always have access to some prior information regarding their ability. This can be actual in game performance or it can be their prestige, aka their recruiting rating. There are a few different metrics by which CFB players are graded (stars, composite ranking, overall class rank) that we can use to give our model some guidance on what to expect from a QB. For context, one important aspect of Bayesian analysis is priors and how they can guide a model in the absence of much data. A prior essentially says that given player x's recruiting ranking, what are the range of outcomes related to a variable of interest (in our case completion percentage). This is a very valuable tool for determining the possible outcomes for a QB who we don't have much information on (such as a freshman or redshirt). Back to CFB recruit grades, we first must determine which of the mentioned variables are most predictive of a CFB QB's completion percentage. Below, I evaluate the correlation between each metric and career completion percentage. 

All metrics are close to each other in terms of correlation. Thus, I chose to use the composite rating (0-100 scale) because of the added layer of granularity relative to stars. We can visualize the relationship between composite rating and CP% with a smoothing spline below. 

### Number of Throws

As mentioned in Empirical Bayes: Examples from Baseball Statistics, one confounder in sports is how many opportunities a player gets. In our case, a QB who is bad will get less opportunities to throw the ball than a QB who is good (this is obvious). The reason this is an issue is because of the plot below, our estimates would be biased and we would shrink players who have low attempts too much towards the overall league average and overestimate CP%. We can account for this by also adding the numbers of attempts to our model.

### Years of Experience

In a similar vain, QB years of experience can also serve as a valuable prior for predicting QB CP%. The visual below displays this relationship and shows that QB experience is correlated with CP%. This is important because of QBs who may have reshirted their freshman year (or QBs who threw very few passes), we know QBs in this situation spent the season learning and this should lead into better QB play their sophomore year. If we only accounted for QB composite ranking then this effect would be missed. A recent example of this is Mac Jones. He was not redshirted but only threw 13 attempts in his freshman year, that sample size is not informative of future performance. 

### Model Fitting


### Analysis & Plots

Now the interesting part, we can observe new Patriots QB Mac Jones and his range of CP% outcomes according to the model. A quick few notes on graphic interpretation:
  - The grey area represents what Mac Jones "true" CP% is at each given throw. As he accumulates more attempts this grey area shrinks because the model is more sure of his CP%. 
  - The big jump at the start of the graphic is when Jones became a sophomore QB. Because there was virtually no evidence of Jones CP%, the prior on experience has a large effect causing his estimate to be much higher. 
  - This should not be interpreted as "we should sit QB x their freshman year because sophomore QBs have a higher CP%". There was still a very wide range of outcomes for Mac entering his sophomore year, from bad to top 25 percentile. 
  - I would argue that the model not putting Mac's final CP% in the credible interval is a sign of validity. Do you really want a model to predict a 95th percentile outcome on a 3 star QB with no evidence?

![placeholder](https://pbs.twimg.com/media/E38zHZwXwAIENfa?format=png&name=4096x4096)

A good comp for how this would work with a highly ranked QB is Trevor Lawrence. 


